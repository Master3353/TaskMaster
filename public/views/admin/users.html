<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/admin.css">
    <title>Manage Users</title>
</head>

<body>
    <nav>
        <div class="nav-content">
            <h2>Admin Dashboard</h2>
            <div class="nav-links">
                <a href="/admin">Dashboard</a>
                <a href="/tasks">My Tasks</a>
                <a href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>User Management</h1>

        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>Active Sessions</th>
                    <th>Tasks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($users as $userRow): ?>
                <tr>
                    <td>
                        <?= $userRow['id'] ?>
                    </td>
                    <td>
                        <?= htmlspecialchars($userRow['firstname'] . ' ' . $userRow['lastname']) ?>
                    </td>
                    <td>
                        <?= htmlspecialchars($userRow['email']) ?>
                    </td>
                    <td>
                        <span class="role-badge role-<?= $userRow['role'] ?>">
                            <?= htmlspecialchars($userRow['role']) ?>
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-<?= $userRow['enabled'] ? 'enabled' : 'disabled' ?>">
                            <?= $userRow['enabled'] ? 'Enabled' : 'Disabled' ?>
                        </span>
                    </td>
                    <td>
                        <?= date('M d, Y', strtotime($userRow['created_at'])) ?>
                    </td>
                    <td>
                        <?= $userRow['last_login'] ? date('M d, Y H:i', strtotime($userRow['last_login'])) : 'Never' ?>
                    </td>
                    <td>
                        <?php if ($userRow['active_sessions'] > 0): ?>
                        <span class="badge badge-warning">
                            <?= $userRow['active_sessions'] ?>
                        </span>
                        <?php else: ?>
                        <span class="badge badge-success">0</span>
                        <?php endif; ?>
                    </td>
                    <td>
                        <?= $userRow['assigned_tasks'] ?>
                    </td>
                    <td class="action-buttons">
                        <a href="/admin/users/view/<?= $userRow['id'] ?>" class="btn btn-small btn-info">
                            View
                        </a>

                        <?php if ($userRow['id'] != $user['id']): ?>
                        <form method="POST" action="/admin/users/toggle/<?= $userRow['id'] ?>" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-warning">
                                <?= $userRow['enabled'] ? 'Disable' : 'Enable' ?>
                            </button>
                        </form>

                        <form method="POST" action="/admin/users/delete/<?= $userRow['id'] ?>" style="display: inline;"
                            onsubmit="return confirm('Are you sure? User can only be deleted if not logged in.');">
                            <button type="submit" class="btn btn-small btn-delete">
                                Delete
                            </button>
                        </form>
                        <?php else: ?>
                        <span class="text-muted">(You)</span>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <script>
        // Auto-refresh to show updated session counts
        setTimeout(() => {
            location.reload();
        }, 60000); // Refresh every minute
    </script>
</body>

</html>